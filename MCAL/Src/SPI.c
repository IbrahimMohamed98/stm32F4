/**********************************************************************************************************************
 *  FILE DESCRIPTION
 *  -----------------------------------------------------------------------------------------------------------------*/
/**    \file  SPI.c
 *    \brief  Serial peripheral interface
 *
 *  \details  This file includes the function that Deliver 1-SPI initiation to specific configuration
 *                                                         2-SPI send/receive functions
 *                                                         3-ISR functions setting
 *
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  INCLUDES
 *********************************************************************************************************************/
#include "../../Libs/BitMath.h"
#include "../../Libs/stmTypes.h"
#include "../../Libs/Registers.h"

#include "../Inc/SPI.h"

/**********************************************************************************************************************
*  LOCAL MACROS CONSTANT\FUNCTION
*********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL DATA 
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  GLOBAL DATA
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL FUNCTION PROTOTYPES
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL FUNCTIONS
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  GLOBAL FUNCTIONS
 *********************************************************************************************************************/

void SPI_init(SPICnfg_t *cnfg){
	if(cnfg->mode == SPI_MASTER){//Check for the mode
		SPI_SET_MASTER(cnfg->SPI);
		SPI_SPI_SET_BAUD_RATE(cnfg->SPI,cnfg->BaudRate);
		if(cnfg ->slaveSlct == SPI_SOFT_SLAVE_SLCT){//check for slave select type 
			BIT_SET(cnfg->SPI->CR,SSM);
		}else{
			BIT_CLR(cnfg->SPI->CR,SSM);
		}
	}else{
		SPI_SET_SLAVE(cnfg->SPI);
	}
	
	if(cnfg->dataOrder == SPI_LSB){//check for data ordering
		SPI_LSB_DATA_ORDER(cnfg->SPI);
	}else{
		SPI_MSB_DATA_ORDER(cnfg->SPI);
	}
	
	cnfg->SPI->CR2 = 0;
	SPI_ENABLE(cnfg->SPI);
}

void SPI_send(volatile SPI_t* SPI,uint8*msg,uint16 size){	
	for(int i = 0;i<size;i++){
		while(!BIT_VAL(SPI->SR,SPI_TXE));//wait untill the receive buffer is empty
		SPI->DR = msg[i];//load the message into the data register
		while(BIT_VAL(SPI->SR,BSY));//wait until message sent
	}	
}

void SPI_receive(volatile SPI_t* SPI,uint8*msg,uint16 size){
	for(int i = 0;i<size;i++){
		while(!BIT_VAL(SPI->SR,SPI_RXNE));//wait untill the receive buffer is empty
		msg[i] = SPI->DR;//Load the content of Data register into the message buffer
	}
}

/**********************************************************************************************************************
 *  END OF FILE: SPI.c
 *********************************************************************************************************************/
